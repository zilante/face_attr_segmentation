### Описание

Это репозиторий с решением задачи семантической сегментации атрибутов лица человека.
В качестве датасета рассматривается [CelebAMask-HQ](https://github.com/switchablenorms/CelebAMask-HQ).
При разработке использовалась библиотека [Segmentation Models](https://github.com/qubvel/segmentation_models.pytorch).
В ней предлагаются 9 различных архитектур для решения задачи сегментации, различные encoder'ы с предобученными весами,
а также популярные метрики и loss'ы.

При разработке этого решения были опробованы несколько различных архитектур:
- Unet;
- FPN;
- PAN;
- PSPNet;
- DeepLabV3+;

А также 2 encoder'а, предобученные на imagenet:
- ResNet (resnet34);
- MobileNet (mobilenet_v2);

Для обучения и тестирования использовались не все данные, а только 5000 картинок: 3375 на train,
375 на validation и 1250 на test. В качестве loss'а при обучении считался [DiceLoss](https://github.com/qubvel/segmentation_models.pytorch/blob/master/segmentation_models_pytorch/losses/dice.py). Итоговыми брались те веса модели, при которых достигалось максимальное значение fscore (средний Dice-score по всем классам) на валидационной выборке.

Среди всех подходов наивысший fscore получился у архитектуры FPN с encoder'ом MobileNet ([ссылка](https://drive.google.com/file/d/1t3AZ8ZzaCQXBPA9V5p3pqgM1A50KCqQN/view?usp=sharing) на веса модели). Ниже представлены результаты, которые получились на тестовом множестве:

|           |skin |nose |eye_g|l_eye|r_eye|l_brow|r_brow|l_ear|r_ear|mouth|u_lip|l_lip|hair |hat  |ear_r|neck_l|neck |cloth|
|-----------|:---:|:---:|:---:|:---:|:---:|:----:|:----:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:----:|:---:|:---:|
|Dice-score |0.924|0.883|0.757|0.839|0.835|0.794 |0.783 |0.777|0.775|0.848|0.827|0.846|0.892|0.504|0.54 |0.151 |0.828|0.744|

### Результаты опробованных подходов

Здесь приводятся результаты (Dice-score) всех подходов на валидационном множестве:

#### ResNet encoder
|             |skin |nose |eye_g|l_eye|r_eye|l_brow|r_brow|l_ear|r_ear|mouth|u_lip|l_lip|hair |hat  |ear_r|neck_l|neck |cloth|fscore|
|-------------|:---:|:---:|:---:|:---:|:---:|:----:|:----:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:----:|:---:|:---:|:--:|
|Unet         |0.898|0.836|0.189|0.828|0.837|0.788 |0.794 |0.804|0.743|0.819|0.816|0.696|0.864|0.496|0.012|0.017 |0.828|0.745|0.717|
|PSPNet       |0.9  |0.856|0.719|0.825|0.786|0.754 |0.734 |0.743|0.704|0.804|0.782|0.813|0.838|0.353|0.398|0.354 |0.756|0.647|0.841|
|FPN          |0.905|0.867|0.897|0.817|0.819|0.777 |0.773 |0.801|0.710|0.79 |0.792|0.819|0.861|0.578|0.484|0.631 |0.809|0.727|0.865|
|PAN          |0.913|0.869|0.939|0.815|0.811|0.786 |0.784 |0.793|0.705|0.816|0.8  |0.824|0.867|0.586|0.422|0.67  |0.816|0.721|0.872|
|DeepLabV3Plus|0.9  |0.86 |0.865|0.808|0.806|0.782 |0.778 |0.779|0.753|0.833|0.805|0.825|0.843|0.479|0.426|0.217 |0.81 |0.726|0.854|

#### MobileNet encoder
|             |skin |nose |eye_g|l_eye|r_eye|l_brow|r_brow|l_ear|r_ear|mouth|u_lip|l_lip|hair |hat  |ear_r|neck_l|neck |cloth|fscore|
|-------------|:---:|:---:|:---:|:---:|:---:|:----:|:----:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:----:|:---:|:---:|:--:|
|Unet         |0.907|0.877|0.09 |0.83 |0.837|0.79  |0.793 |0.784|0.777|0.847|0.836|0.7  |0.84 |0.186|0.393|0.004 |0.793|0.705|0.794|
|PSPNet       |0.881|0.791|0.504|0.779|0.792|0.712 |0.741 |0.682|0.664|0.765|0.767|0.785|0.812|0.212|0.323|0.23  |0.729|0.574|0.815|
|FPN          |0.925|0.884|0.898|0.842|0.853|0.797 |0.805 |0.781|0.791|0.841|0.833|0.846|0.891|0.482|0.512|0.481 |0.837|0.739|0.889|
|PAN          |0.915|0.877|0.81 |0.813|0.815|0.786 |0.775 |0.753|0.764|0.827|0.811|0.819|0.887|0.404|0.461|0.315 |0.824|0.73 |0.88 |
|DeepLabV3Plus|0.923|0.881|0.741|0.828|0.84 |0.794 |0.793 |0.799|0.777|0.845|0.824|0.845|0.889|0.437|0.469|0.089 |0.825|0.765|0.886|

### Инструкция по запуску обучения модели
```bash
$ pip install -r requirements.txt
$ python3 train.py -d <device> -v <path_to_data> <path_to_split_information>
````

Для получения подробной инструкции последней команды:
```bash
$ python3 train.py -h
````

Веса обученной модели сохранятся в файле `"best_model.pth"`.

### Инструкция по запуску тестирования модели
```bash
$ python3 test.py -d <device> -v <path_to_dir_to_save_visualizations> <path_to_model_weights> <path_to_data> <path_to_split_information>
````

Для получения подробной инструкции последней команды:
```bash
$ python3 test.py -h
````

### Пример
Пример обучения, тестирования и визуализации представлен в директории `"/examples"`.